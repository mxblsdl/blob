<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Drag and Drop File Upload</title>
    <style>
      #dropZone {
        width: 300px;
        height: 200px;
        border: 2px dashed #ccc;
        border-radius: 10px;
        text-align: center;
        line-height: 200px;
        font-size: 20px;
        margin: 20px auto;
      }
      .items {
        background-color: aliceblue;
        display: inline flow-root list-item;
        padding: 1rem;
      }
      .btn {
        margin-left: 1rem;
      }
    </style>
  </head>
  <body>
    <h1>Drag and Drop File Upload</h1>
    <div id="dropZone">Drop files here</div>

    <h2>Uploaded Files</h2>
    <ul id="fileList" class="items"></ul>

    <script>
      const dropZone = document.getElementById("dropZone");
      const fileList = document.getElementById("fileList");

      // Prevent default behavior for drag-and-drop events
      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      // Highlight drop zone when file is dragged over
      ["dragenter", "dragover"].forEach((eventName) => {
        dropZone.addEventListener(
          eventName,
          () => {
            dropZone.classList.add("highlight");
          },
          false
        );
      });

      ["dragleave", "drop"].forEach((eventName) => {
        dropZone.addEventListener(
          eventName,
          () => {
            dropZone.classList.remove("highlight");
          },
          false
        );
      });

      // Handle dropped files
      dropZone.addEventListener("drop", handleDrop, false);

      function handleDrop(e) {
        let dt = e.dataTransfer;
        let files = dt.files;

        handleFiles(files);
      }

      // Handle uploaded files
      function handleFiles(files) {
        [...files].forEach(uploadFile);
      }

      // Upload file to server
      function uploadFile(file) {
        let formData = new FormData();
        formData.append("file", file);

        fetch("upload/", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
            fetchFilenames();
          })

          .catch((error) => console.error("Error:", error));
      }

      // Fetch filenames from server
      function fetchFilenames() {
        fetch("files/")
          .then((response) => response.json())
          .then((data) => {
            fileList.innerHTML = ""; // Clear the current list
            data.filenames.forEach((file) => {
              let li = document.createElement("li");
              // Add class here

              let a = document.createElement("a");
              a.href = `/files/${file.filename}`;
              a.textContent = file.filename;
              a.download = file.filename;

              let button = document.createElement("button");
              button.textContent = "delete";
              button.className = "btn";
              button.onclick = () => deleteFile(file.filename);

              li.appendChild(a);
              li.appendChild(button);
              fileList.appendChild(li);
            });
          })
          .catch((error) => console.error("Error:", error));
      }

      // Delete file from server
      function deleteFile(fileId) {
        console.log(fileId);
        fetch(`/files/${fileId}`, {
          method: "DELETE",
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
            fetchFilenames(); // Refresh the file list after deletion
          })
          .catch((error) => console.error("Error:", error));
      }

      // Initial fetch of filenames when the page loads
      window.onload = fetchFilenames;
    </script>
  </body>
</html>
