{% for folder in folders %}
<tr>
  <td>
    <!-- TODO replace with HTMX -->
    <a
      hx-get="/items"
      hx-target="#fileTable"
      hx-vals='{"folder_id": "{{ folder.id }}"}'
      >{{ folder.name }}</a
    >
    <img src="folder.png" height="20px" alt="folderImg" />
  </td>
  <td>~</td>
  <td>~</td>
  {% if folder.name != "../" %}
  <td>
    <a onclick="deleteFolder('{{ folder.id }}')">Delete</a>
  </td>
  {% endif %}
</tr>
{% endfor %} {% for file in files %}
<tr>
  <td>{{ file.name }}</td>
  <td>{{ file.size }}</td>
  <td>{{ file.created_at }}</td>
  <td>
    <!-- Downloading files is not natively supported by HTMX so using a JS function -->
    <a onclick="downloadFile('{{file.id}}')">Download</a>
    <a
      hx-delete="/delete"
      hx-vals='{"file_id": "{{ file.id }}"}'
      hx-trigger="click"
      hx-on::after-request="htmx.trigger('#fileTable', 'triggerItems');alertify.success('Object deleted');"
      hx-swap="none"
      >Delete</a
    >

    <a onclick="createLink('{{ file.id }}')">Create Link</a>
  </td>
</tr>

<script>
  async function downloadFile(file_id) {
    const apiKey = document.querySelector("#key").value;

    const response = await fetch(`/download/${file_id}`, {
      method: "GET",
      headers: { access_token: apiKey },
    }).catch((error) => console.error("Error:", error));

    const disposition = response.headers.get("Content-Disposition");
    const filename = disposition.match(/filename="?([^"]*)"?/)[1];

    // Create a Blob from the response
    const blob = await response.blob();

    // Create a link element, set the download attribute and click it
    const link = document.createElement("a");
    const objectURL = URL.createObjectURL(blob);
    console.log(objectURL)
    link.href = objectURL;
    link.download = filename; // Set the filename here
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(objectURL); // Clean up
  }
</script>
{% endfor %}
